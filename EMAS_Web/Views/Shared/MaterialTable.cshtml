@model IEnumerable<Model.MaterialPiece>
@using Service.Connection

@if (ViewBag.Filtration == true)
{

	<div class="fs-3 m-3">
		Количество найденных позиций = <span id="materialTable_visibleRowsCount" class="fs-3"></span>
	</div>
	<script>
		const materialTableFilter = new TableFilter("materialTable");
	</script>
}

<table id="materialTable" class="table table-striped table-bordered">
	<thead>
		<tr>
			<th><input class="form-check-input" type="checkbox" id="checkAll" onchange="setCheckAllVisibleChildElements(document.querySelector('table#materialTable'), this.checked)"></th>
			<th>
				Id<div class="resizer"></div>
				@if (ViewBag.Filtration == true)
				{
					TableFilterViewModelBuilder _filterBuilder = new("materialTable", "materialTableFilter", 1, "Id");
					_filterBuilder.Filtering(Model.Select(e => e.Id.ToString()).Distinct()).NumericRange().Sortable();
					@await Component.InvokeAsync("TableFilterMenu", _filterBuilder.Build())
				}
			</th>
			<th>
				Тип<div class="resizer"></div>
				@if (ViewBag.Filtration == true)
				{
					TableFilterViewModelBuilder _filterBuilder = new("materialTable", "materialTableFilter", 2, "Тип");
					_filterBuilder.Filtering(Model.Select(e => e.Type).Distinct()).Sortable();
					@await Component.InvokeAsync("TableFilterMenu", _filterBuilder.Build())
				}
			</th>
			<th>
				Марка<div class="resizer"></div>
				@if (ViewBag.Filtration == true)
				{
					TableFilterViewModelBuilder _filterBuilder = new("materialTable", "materialTableFilter", 3, "Марка");
					_filterBuilder.Filtering(Model.Select(e => e.Name).Distinct()).Sortable();
					@await Component.InvokeAsync("TableFilterMenu", _filterBuilder.Build())
				}
			</th>
			<th>
				Ед изм<div class="resizer"></div>
				@if (ViewBag.Filtration == true)
				{
					TableFilterViewModelBuilder _filterBuilder = new("materialTable", "materialTableFilter", 4, "Единицы");
					_filterBuilder.Filtering(Model.Select(e => e.Units).Distinct()).Sortable();
					@await Component.InvokeAsync("TableFilterMenu", _filterBuilder.Build())
				}
			</th>
			<th>
				Кол-во<div class="resizer"></div>
				@if (ViewBag.Filtration == true)
				{
					TableFilterViewModelBuilder _filterBuilder = new("materialTable", "materialTableFilter", 5, "Кол-во");
					_filterBuilder.Filtering(Model.Select(e => e.Amount.ToString()).Distinct()).NumericRange().Sortable();
					@await Component.InvokeAsync("TableFilterMenu", _filterBuilder.Build())
				}
			</th>
			<th>
				Доп-характеристика<div class="resizer"></div>
			</th>
			<th>
				Регистрационный номер<div class="resizer"></div>
				@if (ViewBag.Filtration == true)
				{
					TableFilterViewModelBuilder _filterBuilder = new("materialTable", "materialTableFilter", 7, "Рег. номер");
					_filterBuilder.Filtering(Model.Select(e => e.InventoryNumber).Distinct()).Sortable();
					@await Component.InvokeAsync("TableFilterMenu", _filterBuilder.Build())
				}
			</th>
			<th>
				Место<div class="resizer"></div>
				@if (ViewBag.Filtration == true)
				{
					TableFilterViewModelBuilder _filterBuilder = new("materialTable", "materialTableFilter", 8, "Место хранения");
					_filterBuilder.Filtering(Model.Select(e => e.StorageType).Distinct()).Sortable();
					@await Component.InvokeAsync("TableFilterMenu", _filterBuilder.Build())
				}
			</th>
			<th>
				Коментарий<div class="resizer"></div>
			</th>
			@if (ViewBag.LastEvents != null)
			{
				<th>
					С момента последнего изменения <div class="resizer"></div>
				</th>
			}
			<th>
			</th>
			@if (ViewBag.MaterialEdit != null)
			{
				if (ViewBag.MaterialEdit)
				{
					<th>
					</th>
				}
			}
		</tr>
	</thead>
	<tbody class="table w-100 table-group-divider">
		@foreach (var item in Model)
		{
			<tr class="d-table-row">
				<td class="border border-1">
					<input class="form-check-input" type="checkbox" id="checkbox_@item.Id" value="@item.Id" aria-label="...">
				</td>
				<td class="border border-1">@item.Id</td>
				<td class="border border-1">@item.Type</td>
				<td class="border border-1">@item.Name</td>
				<td class="border border-1">@item.Units</td>
				<td class="border border-1">@item.Amount</td>
				<td class="border border-1">@item.Extras</td>
				<td class="border border-1">@item.InventoryNumber</td>
				<td class="border border-1">@item.StorageType</td>
				<td class="border border-1">@item.Comment</td>
				@if (ViewBag.LastEvents != null)
				{
					<td class="border border-1">@Service.ElapsedTimeFormatter.FormatTimeAgo(ViewBag.LastEvents[item.Id].DateTime)</td>
				}
				<td class="border border-1">
					<form asp-controller="Archive" asp-action="History" method="get">
						<input type="hidden" name="storableObjectId" value="@item.Id" />
						<button type="submit" class="btn btn-primary">История</button>
					</form>
				</td>
				@if (ViewBag.MaterialEdit != null)
				{
					if (ViewBag.MaterialEdit)
					{
						<td class="border border-1">
							<form asp-controller="StorableObject" asp-action="EditMaterial" method="get">
								<input type="hidden" name="objectId" value="@item.Id" />
								<input type="hidden" name="locationId" value="@(ViewBag.LocationId)" />
								<button type="submit" class="btn btn-warning">Изменить</button>
							</form>
						</td>
					}
				}
			</tr>
		}
	</tbody>
</table>

<script>
	window.addEventListener('load', function () {
		materialTableFilter.build();
	});

	makeResizable(document.querySelector('table#materialTable'));
</script>
